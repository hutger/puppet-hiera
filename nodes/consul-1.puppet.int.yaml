---
classes:
  - roles::haproxy::server
  - roles::squid::server


roles::haproxy::server::frontends:
  prx01-dev_http:
    ipaddress : "%{::ipaddress}"
    ports     : '8080'
    mode      : http
    options:
      # Permanent redirect from http to https
      'default_backend'        : 'prx01-dev_http_backend'
      'redirect scheme'        : 'https code 301 if !{ ssl_fc }'
      'capture request header' : 'X-Forwarded-For len 50'
      option                   : [ 'http-server-close' ]
    collect_exported : false


roles::haproxy::server::backends:
  prx01-dev_http_backend:
    mode      : http
    options:
      'balance'        : 'roundrobin'
      option           : [ 'httplog', 'http-server-close' ]


roles::haproxy::server::balancermembers:
  server00:
    listening_service : 'prx01-dev_http_backend'
    server_names      : [ 'server01', 'server02' ] 
    ipaddresses       : [ '10.0.0.10', '10.0.0.11' ]
    ports             : '8080'
    options           : ''


#------------------------------------------------------------------------------
# SQUID DEFINITIONS

roles::squid::server:
  cache_mem: "512 MB"
#  workers      : '3'
#  coredump_dir : '/var/spool/squid'
#  http_ports   : [ '3128' ]

roles::squid::server::http_port: 
  '3128':
    options: 'accel vhost'

roles::squid::server::cache_dir:
  /data:
    type           : 'ufs'
    options        : '15000 32 256 min-size=32769'
    process_number : 2


# Please refer to http://www.squid-cache.org/Doc/config/acl/

roles::squid::server::acls:
  internal_network:
    type          : 'src'
    entries       : [ '10.10.10.0/24', '10.10.20.0/24', '10.10.30.0/24' ]

  remote_urls:
    type          : 'url_regex'
    entries       : [ 'http://example.org/path', 'http://example.com/anotherpath']

  'Safe_ports':
    type          : 'port'
    entries       : [ '80', '8080']

  all:
    type          : 'src'
    entries       : [ '0.0.0.0/0']

  


roles::squid::server::http_accesses:
  'internal_network':
    action          : 'allow'

  remote_urls:
    action          : 'allow'

  '!Safe_ports':
    action          : 'deny'

  'all':
    action          : 'deny'

